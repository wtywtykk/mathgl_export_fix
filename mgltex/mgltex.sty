%%
%% Copyright (C) 2014--2015 by Diego Sejas Viscarra <diego.mathematician@gmail.com>
%% Copyright (C) 2014--2015 by Alexey Balakin <mathgl.abalakin@gmail.com>
%% 
%% This program is free software: you can redistribute it and/or modify it
%% under the terms of the GNU General Public License as published by the
%% Free Software Foundation, either version 3 of the License, or (at your
%% option) any later version.
%% 
%% This program is distributed in the hope that it will be useful, but
%% WITHOUT ANY WARRANTY; without even the implied warranty of
%% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
%% Public License for more details.
%% 
%% You should have received a copy of the GNU General Public License along
%% with this program.  If not, see <http://www.gnu.org/licenses/>.
%%

\def\mgltex@version{4.0}

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{mgltex}[2015/08/17 v\mgltex@version\space Embed MGL scripts into LaTeX documents]

\DeclareOption{draft}{%
  \PassOptionsToPackage{\CurrentOption}{graphicx}%
}
\DeclareOption{final}{%
  \PassOptionsToPackage{\CurrentOption}{graphicx}%
}

\def\mgltexon{%
  \PackageInfo{mgltex}{mglTeX is off}%
  \def\MGL@openout##1##2{%
    \immediate\openout##1="##2"%
  }%
  \def\MGL@openin##1##2{%
    \immediate\openin##1="##2"%
  }%
  \def\MGL@write##1##2{%
    \immediate\write##1{##2}%
  }%
  \def\MGL@read##1##2{%
    \def##2{}%
    \ifeof##1\else%
      \bgroup%
      \endlinechar=-1%
      \immediate\global\read##1 to ##2%
      \egroup%
    \fi%
  }%
  \def\MGL@closeout##1{%
    \immediate\closeout##1%
  }
  \def\MGL@closein##1{%
    \immediate\closein##1%
  }
  \def\MGL@graph@not@found@text{MGL\\image\\not\\found}%
  \def\MGL@graph@not@found@warn{MGL image "\MGL@script@name" not found}%
}
\def\mgltexoff{%
  \PackageInfo{mgltex}{mglTeX is off}%
  \def\MGL@openout##1##2{}%
  \def\MGL@openin##1##2{}%
  \def\MGL@write##1##2{}%
  \def\MGL@read##1##2{}%
  \def\MGL@closeout##1{}
  \def\MGL@closein##1{}
  \def\MGL@graph@not@found@text{\mglTeX\\is off;\\no image\\generated}%
  \def\MGL@graph@not@found@warn{mglTeX is off; MGL image "\MGL@script@name" not generated}%
}
\DeclareOption{on}{\mgltexon}
\DeclareOption{off}{\mgltexoff}

\newif\if@MGL@comments@
\def\mglnocomments{\@MGL@comments@false}
\def\mglcomments{\@MGL@comments@true}
\DeclareOption{nocomments}{\mglnocomments}
\DeclareOption{comments}{\mglcomments}

\DeclareOption{1x}{\def\MGL@scale{1}}
\DeclareOption{2x}{\def\MGL@scale{2}}
\DeclareOption{3x}{\def\MGL@scale{3}}
\DeclareOption{4x}{\def\MGL@scale{4}}
\DeclareOption{5x}{\def\MGL@scale{5}}
\DeclareOption{6x}{\def\MGL@scale{6}}
\DeclareOption{7x}{\def\MGL@scale{7}}
\DeclareOption{8x}{\def\MGL@scale{8}}
\DeclareOption{9x}{\def\MGL@scale{9}}

\DeclareOption{eps}{\def\MGL@graph@ext{.eps}}
\DeclareOption{epsz}{\def\MGL@graph@ext{.epsz}}
\DeclareOption{epsgz}{\def\MGL@graph@ext{.eps.gz}}
\DeclareOption{bps}{\def\MGL@graph@ext{.bps}}
\DeclareOption{bpsz}{\def\MGL@graph@ext{.bpsz}}
\DeclareOption{bpsgz}{\def\MGL@graph@ext{.bps.gz}}
\DeclareOption{pdf}{\def\MGL@graph@ext{.pdf}}
\DeclareOption{png}{\def\MGL@graph@ext{.png}}
\DeclareOption{jpg}{\def\MGL@graph@ext{.jpg}}
\DeclareOption{jpeg}{\def\MGL@graph@ext{.jpeg}}
\DeclareOption{gif}{\def\MGL@graph@ext{.gif}}
\DeclareOption{tex}{\def\MGL@graph@ext{.tex}}

\DeclareOption*{\@unknownoptionerror}

\ExecuteOptions{final,on,nocomments,1x,eps}
\ProcessOptions*

\RequirePackage{keyval}
\RequirePackage{graphicx}
\RequirePackage{verbatim}
\DeclareGraphicsExtensions{%
  .eps,.epsz,.eps.gz,.bps,.bpsz,.bps.gz,.pdf,.png,.jpg,.jpeg,.gif%
}
\let\verbatim@finish\relax

\define@key{mgltex@keys}{dir}{\def\MGL@dir{#1}}
\define@key{mgltex@keys}{scriptsdir}{\def\MGL@scripts@dir{#1}}
\define@key{mgltex@keys}{graphicsdir}{\def\MGL@graphics@dir{#1}}
\define@key{mgltex@keys}{backupsdir}{\def\MGL@backups@dir{#1}}
\def\MGL@quality{2}
\define@key{mgltex@keys}{quality}{\def\MGL@quality{#1}}
\def\MGL@paths{\MGL@dir\MGL@scripts@dir,\MGL@dir\MGL@backups@dir}
\define@key{mgltex@keys}{paths}{\g@addto@macro\MGL@paths{,#1}}

\define@key{MGL@keys}{bb}{\g@addto@macro\graph@keys{bb=#1,}}
\define@key{MGL@keys}{bbllx}{\g@addto@macro\graph@keys{bbllx=#1,}}
\define@key{MGL@keys}{bblly}{\g@addto@macro\graph@keys{bblly=#1,}}
\define@key{MGL@keys}{bburx}{\g@addto@macro\graph@keys{bburx=#1,}}
\define@key{MGL@keys}{bbury}{\g@addto@macro\graph@keys{bbury=#1,}}
\define@key{MGL@keys}{natwidth}{\g@addto@macro\graph@keys{natwidth=#1,}}
\define@key{MGL@keys}{natheight}{\g@addto@macro\graph@keys{natheight=#1,}}
\define@key{MGL@keys}{hiresbb}{\g@addto@macro\graph@keys{hiresbb=#1,}}
\define@key{MGL@keys}{viewport}{\g@addto@macro\graph@keys{viewport=#1,}}
\define@key{MGL@keys}{trim}{\g@addto@macro\graph@keys{trim=#1,}}
\define@key{MGL@keys}{angle}{\g@addto@macro\graph@keys{angle=#1,}}
\define@key{MGL@keys}{origin}{\g@addto@macro\graph@keys{origin=#1,}}
\define@key{MGL@keys}{width}{\g@addto@macro\graph@keys{width=#1,}}
\define@key{MGL@keys}{height}{\g@addto@macro\graph@keys{height=#1,}}
\define@key{MGL@keys}{totalheight}{\g@addto@macro\graph@keys{totalheight=#1,}}
\define@key{MGL@keys}{keepaspectratio}[true]{\g@addto@macro\graph@keys{keepaspectratio=#1,}}
\define@key{MGL@keys}{scale}{\g@addto@macro\graph@keys{scale=#1,}}
\define@key{MGL@keys}{clip}[true]{\g@addto@macro\graph@keys{clip=#1,}}
\define@key{MGL@keys}{draft}[true]{\g@addto@macro\graph@keys{draft=#1,}}
\define@key{MGL@keys}{type}{\g@addto@macro\graph@keys{type=#1,}}
\define@key{MGL@keys}{ext}{\g@addto@macro\graph@keys{ext=#1,}}
\define@key{MGL@keys}{read}{\g@addto@macro\graph@keys{read=#1,}}
\define@key{MGL@keys}{command}{\g@addto@macro\graph@keys{command=#1,}}
\define@key{MGL@keys}{imgext}{\def\MGL@graph@ext{.#1}}

\define@key{MGL@verb@keys}{number}[true]{\csname @MGL@number@#1\endcsname}

\newwrite\MGL@out@stream
\newread\MGL@in@stream
\newcounter{MGL@line@no}
\newcounter{MGL@script@no}
\newcounter{MGL@verb@script@no}
\def\l@MGL@script{\@dottedtocline{1}{0em}{1.5em}}
\newif\if@MGL@number@
\newif\if@MGL@list@script@
\def\MGL@line@sep{\leavevmode\cleaders\hrule height\mgllineheight\hfill\kern\z@}
\def\MGL@bar@sep{\leavevmode\cleaders\hb@xt@\mglbarsep{\hss-\hss}\hfill\kern\z@}
\def\MGL@TeX@ext{.tex}

\def\MGL@setkeys#1#2{%
  \def\graph@keys{}%
  \setkeys{#1}{#2}%
}

\def\MGL@codes{%
  \let\do\@makeother\dospecials%
  \catcode`\^^M\active%
}

\def\MGL@written@scripts{}
\def\MGL@set@script@name#1{%
  \edef\MGL@script@name{#1}%
  \@for\MGL@temp@a:=\MGL@written@scripts\do{%
    \ifx\MGL@temp@a\MGL@script@name%
      \PackageWarning{mgltex}{Multiple MGL scripts named "\MGL@script@name.mgl"}%
    \fi%
  }%
  \g@addto@macro\MGL@written@scripts{\MGL@script@name}%
}

\def\MGL@graph@not@found{%
  \PackageWarning{mgltex}{\MGL@graph@not@found@warn}%
  \fbox{%
    \centering%
    \bfseries\Huge%
    \begin{tabular}{c}\MGL@graph@not@found@text\end{tabular}%
  }%
}

\def\MGL@unchanged#1{%
  \global\@namedef{MGL@@@#1}{}%
}

\def\MGL@process@script#1#2{%
  \@ifundefined{MGL@@@\MGL@script@name}{%
    #1%
  }{%
    \IfFileExists{\MGL@dir\MGL@graphics@dir\MGL@script@name\MGL@graph@ext}{%
      #2%
    }{%
      #1%
    }%
  }%
}

\def\MGL@def@for@loop#1{%
  \long\def\MGL@for##1:=##2\do##3{%
    \expandafter\def\expandafter\@fortmp\expandafter{##2}%
    \ifx\@fortmp\@empty\else%
      \expandafter\MGL@forloop##2#1\@nil#1\@nil\@@##1{##3}%
    \fi%
  }%
  \long\def\MGL@forloop##1#1##2#1##3\@@##4##5{%
    \def##4{##1}%
    \ifx##4\@nnil\else%
      ##5\def##4{##2}%
      \ifx##4\@nnil\else%
        ##5\MGL@iforloop##3\@@##4{##5}%
      \fi%
    \fi%
  }%
  \long\def\MGL@iforloop##1#1##2\@@##3##4{%
    \def##3{##1}%
    \ifx##3\@nnil%
      \expandafter\@fornoop%
    \else%
      ##4\relax\expandafter\MGL@iforloop%
    \fi%
    ##2\@@##3{##4}%
  }%
}
\MGL@def@for@loop{^^J}

\def\MGL@check@script#1{%
  \def\MGL@next{%
    \MGL@closein\MGL@in@stream%
    \MGL@write\@auxout{\string\MGL@unchanged{\MGL@script@name}}%
  }%
  \def\verbatim@processline{%
    \MGL@read\MGL@in@stream{\MGL@temp@a}%
    \edef\MGL@temp@b{\the\verbatim@line}%
    \ifx\MGL@temp@a\MGL@temp@b\else%
      \def\MGL@next{\MGL@closein\MGL@in@stream}%
      \def\verbatim@processline{}%
    \fi%
  }%
  \def\verbatim@finish{%
    \MGL@read\MGL@in@stream{\MGL@temp@a}%
    \ifeof\MGL@in@stream\else%
      \def\MGL@next{\MGL@closein\MGL@in@stream}%
    \fi%
  }%
  \MGL@openin\MGL@in@stream{#1}%
%   \MGL@for\MGL@temp@a:=\MGL@signature\do{\MGL@read\MGL@in@stream{\MGL@temp@b}}%
  \verbatim@start%
}

\def\MGL@includegraphics{%
  \IfFileExists{\MGL@dir\MGL@graphics@dir\MGL@script@name\MGL@graph@ext}{%
    \ifx\MGL@graph@ext\MGL@TeX@ext%
      \include{\MGL@dir\MGL@graphics@dir\MGL@script@name\MGL@graph@ext}%
    \else%
      \expandafter\includegraphics\expandafter[\graph@keys]{\MGL@dir\MGL@graphics@dir\MGL@script@name}%
    \fi%
  }{%
    \MGL@graph@not@found%
  }%
}

\newcommand\mgl[1][]{%
  \define@key{MGL@keys}{label}{\def\MGL@script@name{##1}}%
  \MGL@setkeys{MGL@keys}{#1}%
  \@ifundefined{MGL@script@name}{%
    \stepcounter{MGL@script@no}%
    \edef\MGL@script@name{\MGL@main@script@name-MGL-\arabic{MGL@script@no}}%
  }{}%
  \MGL@set@script@name{\MGL@script@name}%
  \MGL@codes%
  \MGL@process@script{%
    \mgl@write@script%
  }{%
    \MGL@check@script{\MGL@dir\MGL@backups@dir\MGL@script@name.mgl}%
  }%
}
\def\mgl@write@script{%
  \def\MGL@next{%
    \MGL@closeout\MGL@out@stream%
    \MGL@write\MGL@main@stream{%
      write '\MGL@dir\MGL@graphics@dir\MGL@script@name\MGL@graph@ext'^^J%
      ^^Jreset^^J%
    }%
    \MGL@write\@auxout{\string\MGL@unchanged{\MGL@script@name}}%
  }%
  \def\verbatim@processline{%
    \MGL@write\MGL@main@stream{\the\verbatim@line}%
    \MGL@write\MGL@out@stream{\the\verbatim@line}%
  }%
  \MGL@write\MGL@main@stream{quality \MGL@quality}%
  \MGL@openout\MGL@out@stream{\MGL@dir\MGL@backups@dir\MGL@script@name.mgl}%
%   \MGL@write\MGL@out@stream{\MGL@signature}%
  \verbatim@start%
}
\def\endmgl{%
  \MGL@next%
  \MGL@includegraphics%
}

\def\mgladdon{%
  \@bsphack%
  \MGL@codes%
  \def\verbatim@processline{\MGL@write\MGL@main@stream{\the\verbatim@line}}%
  \verbatim@start%
}
\def\endmgladdon{\@esphack}

\newcommand\mglcode[2][]{%
  \MGL@setkeys{MGL@keys}{#1}%
  \MGL@set@script@name{#2}%
  \MGL@codes%
  \MGL@process@script{%
    \mglcode@write@script%
  }{%
    \MGL@check@script{\MGL@dir\MGL@scripts@dir\MGL@script@name.mgl}%
  }%
}
\def\mglcode@write@script{%
  \def\MGL@next{%
    \MGL@closeout\MGL@out@stream%
    \MGL@write\@auxout{\string\MGL@unchanged{\MGL@script@name}}%
    \MGL@write{18}{%
      mglconv -q \MGL@quality\space -S \MGL@scale\space -s "\MGL@dir\MGL@scripts@dir\mglcommonscriptname.mgl" -o "\MGL@dir\MGL@graphics@dir\MGL@script@name\MGL@graph@ext" "\MGL@dir\MGL@scripts@dir\MGL@script@name.mgl"%
    }%
  }%
  \def\verbatim@processline{\MGL@write\MGL@out@stream{\the\verbatim@line}}%
  \MGL@openout\MGL@out@stream{\MGL@dir\MGL@scripts@dir\MGL@script@name.mgl}%
%   \MGL@write\MGL@out@stream{\MGL@signature}%
  \verbatim@start%
}
\def\endmglcode{%
  \MGL@next%
  \MGL@includegraphics%
}

\def\mglscript#1{%
  \@bsphack%
  \MGL@set@script@name{#1}%
  \MGL@codes%
  \def\verbatim@processline{\MGL@write\MGL@out@stream{\the\verbatim@line}}%
  \MGL@openout\MGL@out@stream{\MGL@dir\MGL@scripts@dir\MGL@script@name.mgl}%
%   \MGL@write\MGL@out@stream{\MGL@signature}%
  \verbatim@start%
}
\def\endmglscript{%
  \MGL@closeout\MGL@out@stream%
  \@esphack%
}

\def\MGL@write@funcs{}
\def\MGL@func#1{%
  \MGL@openin\MGL@in@stream{\MGL@dir\MGL@backups@dir#1.mgl}%
  \MGL@@func%
}
\def\MGL@@func{%
  \MGL@read\MGL@in@stream{\MGL@temp@a}%
  \ifeof\MGL@in@stream%
    \MGL@closein\MGL@in@stream%
  \else%
    \MGL@write\MGL@main@stream{\MGL@temp@a}%
    \expandafter\MGL@@func%
  \fi%
}
\newcommand\mglfunc[2][0]{%
  \@bsphack%
  \MGL@set@script@name{#2}%
  \g@addto@macro\MGL@write@funcs{\MGL@func{#2}}%
  \MGL@codes%
  \def\verbatim@processline{\MGL@write\MGL@out@stream{\the\verbatim@line}}%
  \MGL@openout\MGL@out@stream{\MGL@dir\MGL@backups@dir\MGL@script@name.mgl}%
  \MGL@write\MGL@out@stream{func '\MGL@script@name' #1}%
  \verbatim@start%
}
\def\endmglfunc{%
  \MGL@write\MGL@out@stream{return^^J}%
  \MGL@closeout\MGL@out@stream%
  \@esphack%
}%

\def\mglcommon{%
  \@bsphack%
  \MGL@set@script@name{\mglcommonscriptname}%
  \MGL@codes%
  \def\verbatim@processline{\MGL@write\MGL@out@stream{\the\verbatim@line}}%
  \MGL@openout\MGL@out@stream{\MGL@dir\MGL@scripts@dir\MGL@script@name.mgl}%
%   \MGL@write\MGL@out@stream{\MGL@signature}%
  \verbatim@start%
}
\@onlypreamble\mglcommon
\def\endmglcommon{%
  \MGL@closeout\MGL@out@stream%
  \@esphack%
}

% \begingroup%
%   \catcode`#=12\relax%
%   \gdef\MGL@comm@symb{#\space}%
% \endgroup
% \def\MGL@signature{\MGL@comm@symb This script was autogenerated by mglTeX from the document "\MGL@main@script@name.tex" on date \today}
% \def\mglsignature{%
%   \@bsphack%
%   \def\MGL@signature{}%
%   \MGL@codes%
%   \catcode`|=0\relax\catcode`[=1\relax\catcode`]=2\relax%
%   \def\verbatim@processline{%
%     \expandafter\g@addto@macro\expandafter\MGL@signature\expandafter{\expandafter\MGL@comm@symb\the\verbatim@line^^J}%
%   }%
%   \verbatim@start%
% }
% \def\endmglsignature{%
%   \@esphack%
% }

\def\mglsetup#1{\mglfunc{#1}}%
\let\endmglsetup=\endmglfunc

\def\MGL@set@verbatim@env{%
  \if@minipage\else\vskip\parskip\fi%
  \setlength{\labelsep}{1em}%
  \@beginparpenalty\predisplaypenalty%
  \leftskip\@totalleftmargin\rightskip\z@%
  \parindent\z@\parfillskip\@flushglue\parskip\z@%
  \itemsep\z@%
  \@@par%
  \def\par{%
    \if@tempswa%
      \leavevmode\null\@@par\penalty\interlinepenalty%
    \else%
      \@tempswatrue%
      \ifhmode\@@par\penalty\interlinepenalty\fi%
    \fi%
  }%
  \def\@noitemerr{\PackageWarning{mglTeX}{Empty verbatim environment}}%
  \obeylines%
  \let\do\@makeother \dospecials%
  \verbatim@font%
  \everypar \expandafter{\the\everypar \unpenalty}%
  \frenchspacing\@vobeyspaces%
}

\def\mglblock{\@MGL@list@script@true\mglblock@}
\@namedef{mglblock*}{\@MGL@list@script@false\mglblock@}
\newcommand\mglblock@[2][]{%
  \@MGL@number@true%
  \setkeys{MGL@verb@keys}{#1}%
  \MGL@set@script@name{#2}%
  \if@MGL@list@script@%
    \refstepcounter{MGL@verb@script@no}%
    \addcontentsline{lms}{MGL@script}{\protect\numberline{\theMGL@verb@script@no.}\ttfamily\protect\detokenize{\MGL@script@name.mgl}}%
  \fi%
  \if@MGL@number@%
    \setcounter{MGL@line@no}{0}%
    \list{\mgllinenostyle\arabic{MGL@line@no}.}{}%
  \else%
    \list{}{}%
  \fi%
  \MGL@set@verbatim@env%
  \fboxrule=\mgllineheight%
  \item[\MGL@line@sep]\fbox{\bfseries\ttfamily\expandafter\detokenize\expandafter{\MGL@script@name.mgl}}\hskip\labelsep\MGL@line@sep\par\par%
  \def\verbatim@processline{%
    \stepcounter{MGL@line@no}%
    \item\the\verbatim@line%
    \MGL@write\MGL@out@stream{\the\verbatim@line}%
  }%
  \MGL@openout\MGL@out@stream{\MGL@dir\MGL@scripts@dir\MGL@script@name.mgl}%
  \verbatim@start%
}
\def\endmglblock{%
  \MGL@closeout\MGL@out@stream%
  \item[\MGL@line@sep]\hskip-\labelsep\MGL@line@sep%
  \endlist%
}
\expandafter\let\csname endmglblock*\endcsname=\endmglblock

\def\mglverbatim{\@MGL@list@script@true\mglverbatim@}
\@namedef{mglverbatim*}{\@MGL@list@script@false\mglverbatim@}
\newcommand\mglverbatim@[1][]{%
  \@MGL@number@true%
  \define@key{MGL@verb@keys}{label}{\edef\MGL@script@name{##1}}%
  \setkeys{MGL@verb@keys}{#1}%
  \if@MGL@number@%
    \setcounter{MGL@line@no}{0}%
    \list{\mgllinenostyle\arabic{MGL@line@no}.}{}%
  \else%
    \list{}{}%
  \fi%
  \MGL@set@verbatim@env%
  \fboxrule=\mgllineheight%
  \@ifundefined{MGL@script@name}{%
    \def\MGL@script@name{\mglverbscriptname}%
    \item[\MGL@line@sep]\hskip-\labelsep\MGL@line@sep%
  }{%
    \MGL@set@script@name{\MGL@script@name.mgl}%
    \item[\MGL@line@sep]\fbox{\bfseries\ttfamily\expandafter\detokenize\expandafter{\MGL@script@name}}\hskip\labelsep\MGL@line@sep\par\par%
  }%
  \if@MGL@list@script@%
    \refstepcounter{MGL@verb@script@no}%
    \addcontentsline{lms}{MGL@script}{\protect\numberline{\theMGL@verb@script@no.}\ttfamily\protect\detokenize{\MGL@script@name}}%
  \fi%
  \def\verbatim@processline{%
    \stepcounter{MGL@line@no}%
    \item\the\verbatim@line%
  }%
  \verbatim@start%
}
\def\endmglverbatim{%
  \MGL@closeout\MGL@out@stream%
  \item[\MGL@line@sep]\hskip-\labelsep\MGL@line@sep%
  \endlist%
}
\expandafter\let\csname endmglverbatim*\endcsname=\endmglverbatim

\def\mglcomment{%
  \if@MGL@comments@%
    \list{}{}%
    \MGL@set@verbatim@env%
    \item\hskip-\labelsep<\MGL@bar@sep\mglcommentname\MGL@bar@sep>%
    \def\verbatim@processline{\item\the\verbatim@line}%
    \verbatim@start%
  \else%
    \@bsphack%
    \MGL@codes%
    \let\verbatim@startline\relax%
    \let\verbatim@addtoline\@gobble%
    \let\verbatim@processline\relax%
    \let\verbatim@finish\relax%
    \verbatim@%
  \fi%
}
\def\endmglcomment{%
  \if@MGL@comments@%
    \item\hskip-\labelsep<\MGL@bar@sep\mglcommentname\MGL@bar@sep>%
    \endlist%
  \else%
    \@esphack%
  \fi%
}

\newcommand\mglplot[2][]{%
  \def\MGL@mglplot@sep{^^J}%
  \define@key{MGL@keys}{label}{\edef\MGL@script@name{##1}}%
  \define@key{MGL@keys}{setup}{\def\MGL@mglplot@setup{##1}}%
  \define@key{MGL@keys}{separator}{\def\MGL@mglplot@sep{##1}}%
  \MGL@setkeys{MGL@keys}{#1}%
  \expandafter\MGL@def@for@loop\expandafter{\MGL@mglplot@sep}%
  \@ifundefined{MGL@script@name}{%
    \stepcounter{MGL@script@no}
    \edef\MGL@script@name{\MGL@main@script@name-MGL-\arabic{MGL@script@no}}
  }{}%
  \MGL@set@script@name{\MGL@script@name}%
  \@ifundefined{MGL@mglplot@setup}{%
    \edef\MGL@temp@a{#2}%
  }{%
    \edef\MGL@temp@a{call '\MGL@mglplot@setup'\MGL@mglplot@sep #2}%
  }
  \MGL@process@script{%
    \mglplot@write@script%
  }{%
    \mglplot@check@script%
  }%
  \MGL@includegraphics%
}
\def\mglplot@write@script{%
  \MGL@write\MGL@main@stream{quality \MGL@quality}%
  \MGL@openout\MGL@out@stream{\MGL@dir\MGL@backups@dir\MGL@script@name.mgl}%
  \MGL@for\MGL@temp@b:=\MGL@temp@a\do{%
    \MGL@write\MGL@main@stream{\MGL@temp@b}%
    \MGL@write\MGL@out@stream{\MGL@temp@b}%
  }%
  \MGL@closeout\MGL@out@stream%
  \MGL@write\MGL@main@stream{%
    write '\MGL@dir\MGL@graphics@dir\MGL@script@name\MGL@graph@ext'^^J%
    ^^Jreset^^J%
  }%
  \MGL@write\@auxout{\string\MGL@unchanged{\MGL@script@name}}%
}
\def\mglplot@check@script{%
  \def\MGL@next{\MGL@write\@auxout{\string\MGL@unchanged{\MGL@script@name}}}%
  \MGL@openin\MGL@in@stream{\MGL@dir\MGL@backups@dir\MGL@script@name.mgl}%
  \MGL@for\MGL@temp@c:=\MGL@temp@a\do{%
    \MGL@read\MGL@in@stream{\MGL@temp@b}%
    \ifx\MGL@temp@b\MGL@temp@c\else%
      \let\MGL@next=\relax%
    \fi%
  }%
  \MGL@closein\MGL@in@stream%
  \MGL@next%
}

\def\mglsettings#1{\setkeys{mgltex@keys}{#1}}\@onlypreamble\mglsettings
\def\mgldir#1{\def\MGL@dir{#1}}\@onlypreamble\mgldir
\def\mglscriptsdir#1{\def\MGL@scripts@dir{#1}}\@onlypreamble\mglscriptsdir
\def\mglgraphicsdir#1{\def\MGL@graphics@dir{#1}}\@onlypreamble\mglgraphicsdir
\def\mglbackupsdir#1{\def\MGL@backups@dir{#1}}\@onlypreamble\mglbackupsdir
\def\mglquality#1{%
  \def\MGL@quality{#1}%
  \ifcase#1%
    \PackageInfo{mgltex}{Quality 0: No face drawing (fastest)}%
  \or%
    \PackageInfo{mgltex}{Quality 1: No color interpolation (fast)}%
  \or%
    \PackageInfo{mgltex}{Quality 2: High quality (normal)}%
  \or%
    \PackageInfo{mgltex}{Quality 3: High quality with 3d primitives (not implemented yet)}%
  \or%
    \PackageInfo{mgltex}{Quality 4: No face drawing, direct bitmap drawing (low memory usage)}%
  \or%
    \PackageInfo{mgltex}{Quality 5: No color interpolation, direct bitmap drawing (low memory usage)}%
  \or%
    \PackageInfo{mgltex}{Quality 6: High quality, direct bitmap drawing (low memory usage)}%
  \or%
    \PackageInfo{mgltex}{Quality 7: High quality with 3d primitives, direct bitmap drawing (not implemented yet)}%
  \or%
    \PackageInfo{mgltex}{Quality 8: Draw dots instead of primitives (extremely fast)}%
  \else%
    \PackageWarning{mgltex}{Quality #1 not available. Using default (2)}%
    \def\MGL@quality{2}%
  \fi%
}
\def\mglpaths#1{\g@addto@macro\MGL@paths{,#1}}

\newwrite\MGL@main@stream
\edef\MGL@main@script@name{\jobname}
\def\mglname#1{\edef\MGL@main@script@name{#1}}
\AtBeginDocument{%
  \MGL@openout\MGL@main@stream{\MGL@dir\MGL@scripts@dir\MGL@main@script@name.mgl}%
%   \MGL@write\MGL@main@stream{\MGL@signature}%
  \def\mglname#1{%
    \@bsphack%
    \MGL@write\MGL@main@stream{stop^^J}%
    \MGL@write@funcs%
    \MGL@closeout{\MGL@main@stream}%
    \MGL@write{18}{%
      mglconv -q \MGL@quality\space -S \MGL@scale\space -s "\MGL@dir\MGL@scripts@dir\mglcommonscriptname.mgl" -n "\MGL@dir\MGL@scripts@dir\MGL@main@script@name.mgl"%
    }%
    \def\MGL@funcs{}%
    \edef\MGL@main@script@name{#1}%
    \MGL@openout\MGL@main@stream{\MGL@dir\MGL@scripts@dir\MGL@main@script@name.mgl}%
%     \MGL@write\MGL@main@stream{\MGL@signature}%
    \@esphack%
  }%
}
\AtEndDocument{%
  \MGL@write\MGL@main@stream{stop^^J}%
  \MGL@write@funcs%
  \MGL@closeout{\MGL@main@stream}%
  \MGL@write{18}{%
    mglconv -q \MGL@quality\space -S \MGL@scale\space -s "\MGL@dir\MGL@scripts@dir\mglcommonscriptname.mgl" -n "\MGL@dir\MGL@scripts@dir\MGL@main@script@name.mgl"%
  }%
}

\newcommand\mglgraphics[2][]{%
  \bgroup%
  \define@key{MGL@keys}{path}{\def\MGL@forced@path{##1}}%
  \MGL@setkeys{MGL@keys}{#1}%
  \MGL@set@script@name{#2}%
  \IfFileExists{\MGL@dir\MGL@graphics@dir\MGL@script@name\MGL@graph@ext}{}{%
    \@ifundefined{MGL@forced@path}{%
      \def\MGL@next{\PackageWarning{mgltex}{MGL script "\MGL@script@name.mgl" not found}}%
      \@for\MGL@temp@a:=\MGL@paths\do{%
        \IfFileExists{\MGL@temp@a\MGL@script@name.mgl}{%
          \MGL@write{18}{%
            mglconv -q \MGL@quality\space -S \MGL@scale\space -s "\MGL@dir\MGL@scripts@dir\mglcommonscriptname.mgl" -o "\MGL@dir\MGL@graphics@dir\MGL@script@name\MGL@graph@ext" "\MGL@dir\MGL@scripts@dir\MGL@script@name.mgl"%
          }%
          \let\MGL@next=\relax%
        }{}%
      }%
      \MGL@next%
    }{%
      \IfFileExists{\MGL@forced@path\MGL@script@name.mgl}{%
        \MGL@write{18}{%
          mglconv -q \MGL@quality\space -S \MGL@scale\space -s "\MGL@dir\MGL@scripts@dir\mglcommonscriptname.mgl" -o "\MGL@dir\MGL@graphics@dir\MGL@script@name\MGL@graph@ext" "\MGL@dir\MGL@scripts@dir\MGL@script@name.mgl"%
        }%
      }{%
        \PackageWarning{mgltex}{MGL script "\MGL@forced@path\MGL@script@name.mgl" not found}%
      }%
    }%
  }%
  \MGL@includegraphics%
  \egroup%
}

\def\mglinclude{\@MGL@list@script@true\mglinclude@}
\@namedef{mglinclude*}{\@MGL@list@script@false\mglinclude@}
\newcommand\mglinclude@[2][]{%
  \bgroup%
  \@MGL@number@true%
  \define@key{MGL@verb@keys}{path}{\def\MGL@forced@path{##1}}%
  \setkeys{MGL@verb@keys}{#1}%
  \MGL@set@script@name{#2}%
  \@addtofilelist{\MGL@script@name.mgl}%
  \if@MGL@list@script@%
    \refstepcounter{MGL@verb@script@no}%
    \addcontentsline{lms}{MGL@script}{\protect\numberline{\theMGL@verb@script@no.}\ttfamily\protect\detokenize{\MGL@script@name.mgl}}%
  \fi%
  \IfFileExists{\MGL@dir\MGL@graphics@dir\MGL@script@name\MGL@graph@ext}{}{%
    \@ifundefined{MGL@forced@path}{%
      \def\MGL@next{\PackageWarning{mgltex}{MGL script "\MGL@script@name.mgl" not found}}%
      \@for\MGL@temp@a:=\MGL@paths\do{%
        \IfFileExists{\MGL@temp@a\MGL@script@name.mgl}{%
          \mgl@include{\MGL@temp@a\MGL@script@name.mgl}%
          \let\MGL@next=\relax%
        }{}%
      }%
      \MGL@next%
    }{%
      \IfFileExists{\MGL@forced@path\MGL@script@name.mgl}{%
        \mgl@include{\MGL@forced@path\MGL@script@name.mgl}%
      }{%
        \PackageWarning{mgltex}{MGL script "\MGL@forced@path\MGL@script@name.mgl" not found}%
      }%
    }%
  }%
  \egroup%
}
\def\mgl@include#1{%
  \if@MGL@number@%
    \setcounter{MGL@line@no}{0}%
    \list{\mgllinenostyle\arabic{MGL@line@no}.}{}%
  \else%
    \list{}{}%
  \fi%
  \MGL@set@verbatim@env%
  \fboxrule=\mgllineheight%
  \item[\MGL@line@sep]\fbox{\bfseries\ttfamily\expandafter\detokenize\expandafter{\MGL@script@name.mgl}}\hskip\labelsep\MGL@line@sep\par\par%
  \def\verbatim@processline{%
    \stepcounter{MGL@line@no}%
    \item\the\verbatim@line%
  }%
  \immediate\openin\MGL@in@stream="#1"%
  \mgl@@include%
}
\def\mgl@@include{%
  \immediate\read\MGL@in@stream to \MGL@temp@b%
  \ifeof\MGL@in@stream%
    \immediate\closein\MGL@in@stream%
    \item[\MGL@line@sep]\hskip-\labelsep\MGL@line@sep%
    \endlist%
  \else%
    \verbatim@startline%
    \expandafter\verbatim@addtoline\expandafter{\MGL@temp@b}%
    \verbatim@processline%
    \expandafter\mgl@@include%
  \fi%
}

\ifx\l@chapter\@undefined%
  \def\listofmglscripts{%
    \section*{\listofmglscriptsname}%
    \@mkboth{\MakeUppercase\listofmglscriptsname}{\MakeUppercase\listofmglscriptsname}%
    \bgroup\@starttoc{lms}\egroup%
  }%
\else%
  \def\listofmglscripts{%
    \chapter*{\listofmglscriptsname}%
    \@mkboth{\MakeUpperCase\listofmglscriptsname}{\MakeUppercase\listofmglscriptsname}%
    \bgroup\@starttoc{lms}\egroup%
  }%
\fi%

\newcommand\mglTeX[1][]{%
  \bgroup%
  \define@key{mglTeX@keys}{version}[true]{\csname if##1\endcsname v$\mgltex@version$\fi}
  mgl\TeX~\setkeys{mglTeX@keys}{#1}%
  \egroup%
}

\newdimen\mglbarsep\mglbarsep=0.75em%
\newdimen\mgllineheight\mgllineheight=0.25ex%
\def\mgllinenostyle{\footnotesize}
\def\mglcommentname{MGL commentary}
\def\listofmglscriptsname{List of MGL scripts}
\def\mglverbscriptname{(Unnamed MGL verbatim script)}
\def\mglcommonscriptname{MGL_common_script}

% TODO: rename \MGL@main@stream
% TODO: rename MGL@check to \MGL@compare